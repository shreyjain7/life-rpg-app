import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  setDoc, 
  updateDoc 
} from 'firebase/firestore';
import { 
  Check, 
  ChevronLeft, 
  ChevronRight, 
  Trophy, 
  Zap, 
  TrendingUp,
  Settings,
  Plus,
  BarChart2,
  Grid
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants & Data ---
const DEFAULT_HABITS = [
  { id: 'h1', name: 'Wake up at 6AM', icon: 'â°', goal: 30 },
  { id: 'h2', name: 'No Snoozing', icon: 'ðŸš«', goal: 30 },
  { id: 'h3', name: 'Drink 3L Water', icon: 'ðŸ’§', goal: 30 },
  { id: 'h4', name: 'Gym Workout', icon: 'ðŸ‹ï¸', goal: 20 },
  { id: 'h5', name: 'Stretching', icon: 'ðŸ§˜', goal: 30 },
  { id: 'h6', name: 'Read 10 Pages', icon: 'ðŸ“–', goal: 30 },
  { id: 'h7', name: 'Meditation', icon: 'ðŸ§˜', goal: 30 },
  { id: 'h8', name: 'Study 1 Hour', icon: 'ðŸŽ“', goal: 25 },
  { id: 'h9', name: 'Skincare Routine', icon: 'âœ¨', goal: 30 },
  { id: 'h10', name: 'Limit Social Media', icon: 'ðŸ“µ', goal: 30 },
  { id: 'h11', name: 'No Alcohol', icon: 'ðŸš«ðŸº', goal: 30 },
  { id: 'h12', name: 'Track Expenses', icon: 'ðŸ’µ', goal: 30 },
];

const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

// --- Helper Functions ---
const getDatesForMonth = (year, month) => {
  const date = new Date(year, month, 1);
  const dates = [];
  while (date.getMonth() === month) {
    dates.push(new Date(date));
    date.setDate(date.getDate() + 1);
  }
  return dates;
};

const formatDateKey = (date) => {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
};

const getLevel = (xp) => {
  return Math.floor(Math.sqrt(xp / 10)) + 1;
};

const getNextLevelXp = (level) => {
  return Math.pow(level, 2) * 10;
};

// --- Components ---

const ProgressBar = ({ current, max, color = "bg-blue-500" }) => {
  const percentage = Math.min(100, Math.max(0, (current / max) * 100));
  return (
    <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
      <div 
        className={`h-full ${color} transition-all duration-500 ease-out`} 
        style={{ width: `${percentage}%` }}
      />
    </div>
  );
};

const StatsChart = ({ dates, habits, trackingData }) => {
  // Calculate daily percentages
  const dataPoints = dates.map(date => {
    const dateStr = formatDateKey(date);
    const completedCount = habits.filter(h => trackingData[`${dateStr}_${h.id}`]).length;
    const totalCount = habits.length;
    return (completedCount / totalCount) * 100;
  });

  const height = 200;
  const width = 1000; // Virtual width for SVG
  const padding = 20;
  const graphWidth = width - (padding * 2);
  const graphHeight = height - (padding * 2);
  
  // Create points for SVG path
  const points = dataPoints.map((val, index) => {
    const x = padding + (index / (dataPoints.length - 1)) * graphWidth;
    const y = height - padding - (val / 100) * graphHeight;
    return `${x},${y}`;
  }).join(' ');

  // Create fill area path
  const fillPath = `
    ${padding},${height - padding} 
    ${points} 
    ${width - padding},${height - padding}
  `;

  // Calculate Average
  const average = Math.round(dataPoints.reduce((a, b) => a + b, 0) / dataPoints.length);

  return (
    <div className="w-full bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div className="flex justify-between items-end mb-6">
        <div>
          <h3 className="text-lg font-bold text-gray-800">Monthly Consistency</h3>
          <p className="text-sm text-gray-500">Your daily habit completion rate</p>
        </div>
        <div className="text-right">
          <div className="text-3xl font-bold text-blue-600">{average}%</div>
          <div className="text-xs text-gray-400 font-medium uppercase">Average</div>
        </div>
      </div>
      
      <div className="relative w-full h-64 overflow-hidden">
        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full" preserveAspectRatio="none">
          {/* Grid Lines */}
          {[0, 25, 50, 75, 100].map(pct => {
             const y = height - padding - (pct / 100) * graphHeight;
             return (
               <g key={pct}>
                 <line x1={padding} y1={y} x2={width - padding} y2={y} stroke="#f3f4f6" strokeWidth="2" />
                 <text x={0} y={y + 4} fontSize="12" fill="#9ca3af">{pct}%</text>
               </g>
             )
          })}

          {/* Graph Fill (Gradient) */}
          <defs>
            <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.2" />
              <stop offset="100%" stopColor="#3b82f6" stopOpacity="0" />
            </linearGradient>
          </defs>
          <path d={fillPath} fill="url(#chartGradient)" />

          {/* Graph Line */}
          <polyline 
            points={points} 
            fill="none" 
            stroke="#3b82f6" 
            strokeWidth="3" 
            strokeLinecap="round" 
            strokeLinejoin="round" 
          />

          {/* Data Points */}
          {dataPoints.map((val, index) => {
            const x = padding + (index / (dataPoints.length - 1)) * graphWidth;
            const y = height - padding - (val / 100) * graphHeight;
            return (
              <circle 
                key={index} 
                cx={x} 
                cy={y} 
                r="4" 
                fill="white" 
                stroke="#3b82f6" 
                strokeWidth="2" 
                className="hover:r-6 transition-all duration-300"
              />
            );
          })}
        </svg>
      </div>

      <div className="flex justify-between mt-2 px-2">
         {dates.filter((_, i) => i % 5 === 0).map((d, i) => (
           <span key={i} className="text-xs text-gray-400">{d.getDate()}</span>
         ))}
      </div>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [trackingData, setTrackingData] = useState({});
  const [currentDate, setCurrentDate] = useState(new Date());
  const [habits, setHabits] = useState(DEFAULT_HABITS);
  const [view, setView] = useState('grid'); // 'grid' | 'stats'
  
  // Auth Setup
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Data Sync
  useEffect(() => {
    if (!user) return;
    const trackingRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'tracking');
    const unsubscribeTracking = onSnapshot(trackingRef, (docSnap) => {
      if (docSnap.exists()) setTrackingData(docSnap.data());
    });
    return () => unsubscribeTracking();
  }, [user]);

  // Handlers
  const toggleHabit = async (habitId, dateStr) => {
    if (!user) return;
    const key = `${dateStr}_${habitId}`;
    const newValue = !trackingData[key];
    const newTrackingData = { ...trackingData, [key]: newValue };
    setTrackingData(newTrackingData);

    const trackingRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'tracking');
    try {
      await setDoc(trackingRef, { [key]: newValue }, { merge: true });
    } catch (err) {
      setTrackingData(trackingData); 
    }
  };

  const changeMonth = (offset) => {
    const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
    setCurrentDate(newDate);
  };

  // Derived State
  const dates = useMemo(() => getDatesForMonth(currentDate.getFullYear(), currentDate.getMonth()), [currentDate]);
  
  const totalXP = useMemo(() => {
    return Object.values(trackingData).filter(v => v === true).length * 10;
  }, [trackingData]);
  
  const level = getLevel(totalXP);
  const nextLevelXp = getNextLevelXp(level);
  const currentLevelBaseXp = getNextLevelXp(level - 1);
  const levelProgress = totalXP - currentLevelBaseXp;
  const levelTarget = nextLevelXp - currentLevelBaseXp;

  const isToday = (date) => {
    const today = new Date();
    return date.getDate() === today.getDate() && 
           date.getMonth() === today.getMonth() && 
           date.getFullYear() === today.getFullYear();
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50 text-gray-800 font-sans">
      {/* Top Bar / Gamification Header */}
      <header className="bg-white border-b border-gray-200 px-4 py-4 shadow-sm z-30">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
          
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 text-white p-2 rounded-lg shadow-md">
              <Zap size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-gray-900 leading-none">Life RPG</h1>
              <p className="text-xs text-gray-500 mt-1">Max out your stats</p>
            </div>
          </div>

          <div className="flex-1 max-w-md w-full px-2">
            <div className="flex justify-between text-sm mb-1 font-medium">
              <span className="text-blue-600">Level {level}</span>
              <span className="text-gray-400">{totalXP} XP</span>
            </div>
            <ProgressBar current={levelProgress} max={levelTarget} color="bg-blue-500" />
            <div className="text-right text-[10px] text-gray-400 mt-1">
              Next level in {levelTarget - levelProgress} XP
            </div>
          </div>

          <div className="flex items-center gap-2 justify-between md:justify-end w-full md:w-auto mt-2 md:mt-0">
             <div className="flex items-center bg-gray-100 rounded-lg p-1 mr-4">
                <button 
                  onClick={() => setView('grid')}
                  className={`p-2 rounded-md transition-all ${view === 'grid' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                  title="Grid View"
                >
                  <Grid size={18} />
                </button>
                <button 
                  onClick={() => setView('stats')}
                  className={`p-2 rounded-md transition-all ${view === 'stats' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                  title="Stats View"
                >
                  <BarChart2 size={18} />
                </button>
             </div>

            <div className="flex items-center gap-1 bg-gray-50 rounded-full px-2 py-1 border border-gray-200">
                <button 
                onClick={() => changeMonth(-1)}
                className="p-1 hover:bg-white rounded-full transition-colors"
                >
                <ChevronLeft size={16} />
                </button>
                <span className="font-semibold text-sm w-24 text-center select-none">
                {currentDate.toLocaleString('default', { month: 'short', year: 'numeric' })}
                </span>
                <button 
                onClick={() => changeMonth(1)}
                className="p-1 hover:bg-white rounded-full transition-colors"
                >
                <ChevronRight size={16} />
                </button>
            </div>
          </div>

        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-hidden relative flex flex-col bg-gray-100/50">
        
        {view === 'stats' ? (
          <div className="flex-1 overflow-auto p-4 md:p-8">
            <div className="max-w-4xl mx-auto space-y-6">
              <StatsChart dates={dates} habits={habits} trackingData={trackingData} />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Mini Stat Cards */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h4 className="text-sm font-bold text-gray-400 uppercase mb-2">Total Check-ins</h4>
                    <p className="text-3xl font-bold text-gray-800">
                       {Object.values(trackingData).filter(v => v === true).length}
                    </p>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h4 className="text-sm font-bold text-gray-400 uppercase mb-2">Active Habits</h4>
                    <p className="text-3xl font-bold text-gray-800">{habits.length}</p>
                </div>
              </div>
            </div>
          </div>
        ) : (
          /* Grid View */
          <div className="flex-1 overflow-auto bg-white shadow-inner">
            <table className="border-collapse min-w-full">
              {/* Table Header */}
              <thead className="bg-gray-100 text-gray-600 sticky top-0 z-20 shadow-sm">
                <tr>
                  <th className="sticky left-0 top-0 z-30 bg-gray-100 border-b border-r border-gray-300 min-w-[180px] p-3 text-left font-bold text-xs uppercase tracking-wider shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                    Daily Habits
                  </th>
                  <th className="border-b border-r border-gray-300 w-16 p-2 text-center font-bold text-xs uppercase tracking-wider bg-gray-100 hidden md:table-cell">
                    Goal
                  </th>
                  {dates.map((date) => (
                    <th 
                      key={date.toISOString()} 
                      className={`border-b border-r border-gray-300 min-w-[40px] p-2 text-center relative ${isToday(date) ? 'bg-blue-50' : ''}`}
                    >
                      <div className="text-[10px] text-gray-400 font-medium mb-1">
                        {DAYS[date.getDay()]}
                      </div>
                      <div className={`text-sm font-bold ${isToday(date) ? 'text-blue-600 bg-blue-100 w-6 h-6 rounded-full flex items-center justify-center mx-auto' : 'text-gray-700'}`}>
                        {date.getDate()}
                      </div>
                    </th>
                  ))}
                </tr>
              </thead>
              
              {/* Table Body */}
              <tbody>
                {habits.map((habit) => (
                  <tr key={habit.id} className="hover:bg-gray-50 group">
                    <td className="sticky left-0 z-10 bg-white group-hover:bg-gray-50 border-b border-r border-gray-200 p-3 text-sm font-medium text-gray-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] whitespace-nowrap">
                      <span className="mr-2 text-lg inline-block w-6 text-center">{habit.icon}</span>
                      {habit.name}
                    </td>
                    
                    <td className="border-b border-r border-gray-200 p-2 text-center text-xs text-gray-500 font-mono hidden md:table-cell">
                      {habit.goal}
                    </td>
                    
                    {dates.map((date) => {
                      const dateStr = formatDateKey(date);
                      const isChecked = trackingData[`${dateStr}_${habit.id}`];
                      
                      return (
                        <td 
                          key={`${habit.id}-${dateStr}`}
                          className={`border-b border-r border-gray-200 p-0 text-center relative cursor-pointer select-none transition-colors duration-200 ${isChecked ? 'bg-blue-50' : ''}`}
                          onClick={() => toggleHabit(habit.id, dateStr)}
                        >
                          <div className="w-full h-10 md:h-12 flex items-center justify-center">
                            <div 
                              className={`
                                w-5 h-5 md:w-6 md:h-6 rounded border-2 flex items-center justify-center transition-all duration-200
                                ${isChecked 
                                  ? 'bg-blue-500 border-blue-500 scale-100' 
                                  : 'bg-white border-gray-300 hover:border-blue-300 scale-90 opacity-60 group-hover:opacity-100'}
                              `}
                            >
                              {isChecked && <Check size={14} className="text-white stroke-[3]" />}
                            </div>
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </main>
    </div>
  );
}
